#================================================================
# Mihomo (Clash.Meta) Core - Sub-Store 模板
#
# 作者: Gemini
# 日期: 2025-06-29
# 版本: v2.0 (已整合自定义分组和规则)
#
# 使用说明:
# 1. 将此文件的内容粘贴到 Sub-Store 的 "本地配置" 或 "模板配置" 编辑器中。
# 2. Sub-Store 会自动将远程订阅中的节点列表填入此模板，并生成最终的配置文件。
# 3. 此模板专为在服务器、路由器等无头环境下运行的 Core 版本优化。
#
# 特点:
# - 预设通用端口和局域网访问权限。
# - 强大的 DNS Fake-IP 模式，有效防污染并实现精准路由。
# - 预设 TUN 模式，可接管系统所有流量。
# - 已整合复杂的多级代理分组策略和基于 rule-provider 的精细化分流规则。
#================================================================

#------------------------------------------------
# 基础配置 (Ports & General Settings)
#------------------------------------------------
mixed-port: 7890             # HTTP 和 SOCKS5 混合代理端口
redir-port: 7892             # 透明代理 (Redirect) 端口
tproxy-port: 7893            # 透明代理 (TProxy) 端口
allow-lan: true              # 允许来自局域网的连接
bind-address: '*'            # 监听所有网络接口 ('*' 表示所有, '127.0.0.1' 表示仅本机)
mode: rule                   # 模式: rule(规则) / global(全局) / direct(直连)
log-level: info              # 日志级别: silent / error / warning / info / debug
ipv6: true                   # 开启 IPv6 支持

#------------------------------------------------
# 外部控制 & Web UI
#------------------------------------------------
external-controller: '0.0.0.0:9090'  # RESTful API 监听地址，允许外部访问
# external-ui: /etc/mihomo/ui        # (可选) Web UI (如 metacubexd) 的文件路径
# secret: ""                         # (可选) API 访问密钥，增强安全性

#------------------------------------------------
# DNS 配置 (核心功能)
#------------------------------------------------
dns:
  enable: true
  listen: 0.0.0.0:1053          # DNS 监听端口
  ipv6: true                    # 允许解析 AAAA 记录
  enhanced-mode: fake-ip        # 增强模式: fake-ip (推荐) 或 redir-host
  fake-ip-range: 198.18.0.1/16  # Fake-IP 使用的地址池
  use-hosts: true               # 使用系统 hosts 文件
  nameserver:
    - https://223.5.5.5/dns-query     # AliDNS
    - https://doh.pub/dns-query       # Tencent DoH
    - tls://dns.google                # Google DoT
  fallback:
    - https://1.1.1.1/dns-query       # Cloudflare
    - https://dns.quad9.net/dns-query # Quad9
    - tls://8.8.4.4:853
  nameserver-policy:
    'geosite:cn':
      - https://223.5.5.5/dns-query
      - https://doh.pub/dns-query
    'geosite:apple_cn':
      - https://223.5.5.5/dns-query

#------------------------------------------------
# TUN 模式 (可选, 用于接管系统所有流量)
#------------------------------------------------
tun:
  enable: true
  stack: gvisor                 # 协议栈: system / gvisor / mixed
  dns-hijack:
    - any:1053                  # 劫持所有发往 1053 端口的 DNS 查询
  auto-route: true              # 自动设置路由表，将流量导向 TUN
  auto-detect-interface: true   # 自动检测出口网卡

#================================================================
# Sub-Store 填充区域
# proxies: []
# proxy-groups: []
# rule-providers: []
# rules: []
#================================================================

#------------------------------------------------
# 代理组 (Proxy Groups)
#------------------------------------------------
proxy-groups:
  - name: 'ProxyScheme'
    type: select
    proxies:
      - 'DailyLowRate'
      - 'RegionSelect'
      - 'GlobalAuto'
      - 'ResidentialISP'
      - 'AutoFallback'
      - 'DownloadNodes'
      - DIRECT
      # $proxies # Sub-Store 会在此处插入所有节点

  - name: 'RegionSelect'
    type: select
    proxies:
      - 'HongKong'
      - 'Taiwan'
      - 'Japan'
      - 'Korea'
      - 'Singapore'
      - 'USA'
      - 'America'
      - 'Europe'
      - 'Others'

  - name: 'DailyLowRate'
    type: url-test
    url: 'http://www.gstatic.com/generate_204'
    interval: 86400
    tolerance: 50
    filter: 7li7li
    exclude-filter: (?i)(GB|Traffic|Expire|Premium|频道|订阅|ISP|流量|到期|重置|x([2-9]|\d{2,})(\.\d+)?|(([2-9]|\d{2,})(\.\d+)?)[Xx×]|萌云|香港)
    proxies:
      # $proxies

  - name: 'GlobalAuto'
    type: url-test
    url: 'http://www.gstatic.com/generate_204'
    interval: 86400
    tolerance: 50
    exclude-filter: (?i)GB|Traffic|Expire|Premium|频道|订阅|ISP|流量|到期|重置|香港|萌云|新加坡
    proxies:
      # $proxies

  - name: 'ResidentialISP'
    type: select
    filter: Fam
    exclude-filter: 香港|HK|🇭🇰
    proxies:
      # $proxies

  - name: 'AutoFallback'
    type: fallback
    url: 'http://www.gstatic.com/generate_204'
    interval: 7200
    exclude-filter: (?i)GB|Traffic|Expire|Premium|频道|订阅|ISP|流量|到期|重置
    proxies:
      # $proxies

  - name: 'DownloadNodes'
    type: url-test
    url: 'http://www.gstatic.com/generate_204'
    interval: 300
    filter: (?i)(?:[x×倍])\s*0\.\d+|0\.\d+\s*(?:[x×倍])|Test|6bcloud|起帆
    exclude-filter: 6bcloud丨 台湾 GPT|越南
    proxies:
      # $proxies

  - name: 'HongKong'
    type: url-test
    url: 'http://www.gstatic.com/generate_204'
    interval: 86400
    tolerance: 50
    filter: 香港|HK|🇭🇰
    proxies:
      # $proxies

  - name: 'Taiwan'
    type: url-test
    url: 'http://www.gstatic.com/generate_204'
    interval: 86400
    tolerance: 50
    filter: 台湾|TW|🇹🇼
    proxies:
      # $proxies

  - name: 'Japan'
    type: url-test
    url: 'http://www.gstatic.com/generate_204'
    interval: 86400
    tolerance: 50
    filter: 日本|JP|🇯🇵
    proxies:
      # $proxies

  - name: 'Korea'
    type: url-test
    url: 'http://www.gstatic.com/generate_204'
    interval: 86400
    tolerance: 50
    filter: 韩国|KR|🇰🇷
    proxies:
      # $proxies

  - name: 'Singapore'
    type: url-test
    url: 'http://www.gstatic.com/generate_204'
    interval: 86400
    tolerance: 50
    filter: 新加坡|SG|🇸🇬
    proxies:
      # $proxies

  - name: 'USA'
    type: url-test
    url: 'http://www.gstatic.com/generate_204'
    interval: 86400
    tolerance: 50
    filter: 美国|US|🇺🇸
    proxies:
      # $proxies

  - name: 'America'
    type: url-test
    url: 'http://www.gstatic.com/generate_204'
    interval: 86400
    tolerance: 50
    filter: 加拿大|CA|🇨🇦|巴西|BR|🇧🇷|智利|CL|🇨🇱
    proxies:
      # $proxies

  - name: 'Europe'
    type: url-test
    url: 'http://www.gstatic.com/generate_204'
    interval: 86400
    tolerance: 50
    filter: 德国|DE|🇩🇪|法国|FR|🇫🇷|英国|GB|🇬🇧|荷兰|NL|🇳🇱|意大利|IT|🇮🇹
    proxies:
      # $proxies

  - name: 'Others'
    type: url-test
    url: 'http://www.gstatic.com/generate_204'
    interval: 86400
    tolerance: 50
    exclude-filter: (?i)GB|Traffic|Expire|Premium|频道|订阅|ISP|流量|到期|重置|德国|DE|🇩🇪|法国|FR|🇫🇷|英国|GB|🇬🇧|荷兰|NL|🇳🇱|意大利|IT|🇮🇹|美国|US|🇺🇸|加拿大|CA|🇨🇦|巴西|BR|🇧🇷|智利|CL|🇨🇱|香港|HK|🇭🇰|台湾|TW|🇹🇼|日本|JP|🇯🇵|韩国|KR|🇰🇷|新加坡|SG|🇸🇬
    proxies:
      # $proxies

#------------------------------------------------
# 规则提供者 (Rule Providers)
#------------------------------------------------
rule-providers:
  Apple:
    type: http
    behavior: classical
    url: https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Apple/Apple_Classical.yaml
    interval: 86400
  Telegram:
    type: http
    behavior: classical
    url: https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Telegram/Telegram.yaml
    interval: 86400
  YouTube:
    type: http
    behavior: classical
    url: https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/YouTube/YouTube.yaml
    interval: 86400
  BiliBili:
    type: http
    behavior: classical
    url: https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/BiliBili/BiliBili.yaml
    interval: 86400
  TikTok:
    type: http
    behavior: classical
    url: https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/TikTok/TikTok.yaml
    interval: 86400
  Spotify:
    type: http
    behavior: classical
    url: https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Spotify/Spotify.yaml
    interval: 86400
  Netflix:
    type: http
    behavior: classical
    url: https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Netflix/Netflix.yaml
    interval: 86400
  Disney:
    type: http
    behavior: classical
    url: https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Disney/Disney.yaml
    interval: 86400
  Google:
    type: http
    behavior: classical
    url: https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Google/Google.yaml
    interval: 86400
  OpenAI:
    type: http
    behavior: classical
    url: https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/OpenAI/OpenAI.yaml
    interval: 86400
  Microsoft:
    type: http
    behavior: classical
    url: https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Microsoft/Microsoft.yaml
    interval: 86400
  Twitter:
    type: http
    behavior: classical
    url: https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Twitter/Twitter.yaml
    interval: 86400
  Steam:
    type: http
    behavior: classical
    url: https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Steam/Steam.yaml
    interval: 86400
  OneDrive:
    type: http
    behavior: classical
    url: https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/OneDrive/OneDrive.yaml
    interval: 86400
  Emby:
    type: http
    behavior: classical
    url: https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Emby/Emby.yaml
    interval: 86400
  Gemini:
    type: http
    behavior: classical
    url: https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Gemini/Gemini.yaml
    interval: 86400
  Claude:
    type: http
    behavior: classical
    url: https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Claude/Claude.yaml
    interval: 86400
  Github:
    type: http
    behavior: classical
    url: https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/GitHub/GitHub_No_Resolve.yaml
    interval: 86400

#------------------------------------------------
# 规则 (Rules)
#------------------------------------------------
rules:
  - RULE-SET,Telegram,ProxyScheme
  - RULE-SET,YouTube,DownloadNodes
  - RULE-SET,BiliBili,DIRECT
  - RULE-SET,TikTok,DownloadNodes
  - RULE-SET,Spotify,DownloadNodes
  - RULE-SET,Netflix,DownloadNodes
  - RULE-SET,Disney,DownloadNodes
  - RULE-SET,Google,ProxyScheme
  - RULE-SET,OpenAI,ResidentialISP
  - RULE-SET,Microsoft,ProxyScheme
  - RULE-SET,Twitter,ProxyScheme
  - RULE-SET,Steam,ProxyScheme
  - RULE-SET,OneDrive,DownloadNodes
  - RULE-SET,Emby,DownloadNodes
  - RULE-SET,Github,ProxyScheme
  - GEOIP,CN,DIRECT
  - MATCH,ProxyScheme
